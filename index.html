<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤‡è€ƒç³»ç»Ÿ</title>
<style>
    /* === ç±³å’–è‰²ç³»é…è‰²å®šä¹‰ === */
    :root {
        /* ä¸»è‰²ï¼šç„¦ç³–å’– */
        --primary: #9c6644; 
        /* è¾…è‰²ï¼šæ·±å’–å•¡ï¼ˆç”¨äºæ–‡å­—å’Œæ·±è‰²èƒŒæ™¯ï¼‰ */
        --dark: #4a3b32;
        /* èƒŒæ™¯è‰²ï¼šæ¸©æš–ç±³ç™½/çº¸å¼ è‰² */
        --bg: #fdfbf7;
        /* æˆåŠŸè‰²ï¼šæŠ¹èŒ¶ç»¿ (ä½é¥±å’Œåº¦) */
        --success: #6b8c42;
        /* é”™è¯¯è‰²ï¼šè±†æ²™çº¢ (ä½é¥±å’Œåº¦) */
        --error: #c05c48;
        /* è­¦å‘Šè‰²ï¼šå§œé»„ */
        --warning: #e09f3e;
        
        /* UI è¾…åŠ©è‰² */
        --card-bg: #ffffff;
        --light-coffee: #f3ebe3; /* æµ…å’–è‰²ï¼Œç”¨äºé€‰ä¸­æ€ */
        --border-color: #e8e0d5;

        /* === è€ƒè¯•æ¨¡å¼ä¸“ç”¨è‰² (è“è‰²) === */
        --exam-selected: #4a90e2; 
        --exam-selected-bg: #eef6ff;
    }

    * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 15px;
        color: var(--dark);
    }

    .container {
        background: var(--card-bg);
        width: 100%;
        max-width: 800px;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(74, 59, 50, 0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 85vh;
        min-height: 600px;
        position: relative;
    }

    @media (max-width: 600px) {
        body {
            padding: 0;
            background: var(--card-bg);
        }

        .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
            box-shadow: none;
            max-width: 100%;
        }
    }

    .view-section {
        display: none;
        flex: 1;
        flex-direction: column;
        height: 100%;
    }

    .view-section.active {
        display: flex;
    }

    /* === é¦–é¡µï¼šç°ä»£ä»ªè¡¨ç›˜é£æ ¼ === */
    .start-screen { 
        padding: 0; 
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        overflow-y: auto; 
        background: var(--card-bg); 
    }
    
    /* 1. é¡¶éƒ¨ Hero åŒºåŸŸ */
    .home-header {
        background: linear-gradient(135deg, #9c6644, #7f5539);
        padding: 40px 25px 50px;
        color: #fcfcfc;
        border-radius: 0 0 25px 25px;
        margin-bottom: -30px;
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(156, 102, 68, 0.3);
    }
    .user-greeting { font-size: 24px; font-weight: 800; margin-bottom: 5px; color: #fff; }
    .app-subtitle { opacity: 0.9; font-size: 13px; margin: 0; color: rgba(255,255,255,0.9); text-align: left; }

    /* 2. ä¸»åŠŸèƒ½å¡ç‰‡åŒº */
    .menu-section { padding: 0 20px; margin-bottom: 25px; flex-shrink: 0; }
    .menu-grid { 
        display: grid; grid-template-columns: 1fr; gap: 15px; 
        width: 100%; max-width: 100%; margin: 0 auto; 
    }
    @media (min-width: 600px) { .menu-grid { grid-template-columns: 1fr 1fr 1fr; } }

    .menu-card {
        background: white; border: none;
        border-radius: 16px; padding: 20px;
        cursor: pointer; transition: 0.2s;
        display: flex; align-items: center;
        gap: 15px; position: relative; overflow: hidden;
        box-shadow: 0 4px 15px rgba(74, 59, 50, 0.05);
        border: 1px solid var(--border-color);
    }
    .menu-card:active { transform: scale(0.98); background: var(--light-coffee); }
    
    .menu-icon-box { 
        width: 50px; height: 50px; border-radius: 12px; background: #f5efe6; 
        display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;
        color: var(--primary);
    }
    .menu-text { display: flex; flex-direction: column; flex: 1; }
    .menu-title { font-size: 16px; font-weight: bold; color: var(--dark); margin-bottom: 4px; }
    .menu-desc { font-size: 12px; color: #9d8b80; }
    
    .card-mistake .menu-icon-box { background: #fdf2f2; }
    .card-mistake .menu-title { color: var(--error); }
    .card-mistake .menu-icon-box { color: var(--error); }

    /* 3. å·¥å…·æ åŒºåŸŸ */
    .tools-section { padding: 0 20px 30px; }
    .section-label { font-size: 13px; font-weight: bold; color: #9d8b80; margin-bottom: 12px; padding-left: 5px; }
    
    .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .tool-btn {
        background: #fcfaf8; border: 1px solid var(--border-color);
        padding: 12px; border-radius: 10px;
        font-size: 13px; color: #6d5d53; font-weight: 600;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        cursor: pointer; transition: 0.2s;
    }
    .tool-btn:active { background: var(--light-coffee); border-color: #d7ccc8; }
    .tool-btn i { font-style: normal; font-size: 16px; }
    .tool-lock { color: var(--error); background: #fffbfb; border-color: #f2e6e6; }

    /* === é¡¶éƒ¨æ  === */
    .select-header,
    .quiz-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #fff;
        flex-shrink: 0;
        height: 60px;
    }

    .back-icon {
        cursor: pointer;
        font-size: 22px;
        padding: 5px 10px 5px 0;
        color: #6d5d53;
        font-weight: bold;
    }

    .header-title {
        font-size: 18px;
        font-weight: bold;
        color: var(--dark);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-left: 5px;
    }

    .exit-btn {
        font-size: 14px;
        color: var(--error);
        cursor: pointer;
        border: 1px solid var(--error);
        padding: 6px 12px;
        border-radius: 20px;
        background: white;
        margin-left: 10px;
    }

    /* === è®¡æ—¶å™¨æ ·å¼ === */
    .timer-badge {
        font-family: monospace;
        font-size: 16px;
        font-weight: bold;
        color: var(--dark);
        background: var(--light-coffee);
        padding: 4px 10px;
        border-radius: 6px;
        margin: 0 10px;
        flex-shrink: 0;
    }
    
    /* å€’è®¡æ—¶å³å°†ç»“æŸæ—¶çš„æ ·å¼ */
    .timer-badge.urgent {
        color: #fff;
        background: var(--error);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.8; }
        100% { opacity: 1; }
    }

    .score-board {
        font-size: 14px;
        font-weight: bold;
        color: var(--primary);
        background: var(--light-coffee);
        padding: 6px 15px;
        border-radius: 20px;
    }

    /* === åˆ—è¡¨ === */
    .set-list {
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 15px;
        overflow-y: auto;
        background: var(--bg);
    }

    @media (max-width: 600px) {
        .set-list {
            grid-template-columns: 1fr 1fr;
        }
    }

    .set-card {
        background: white;
        border: 1px solid var(--border-color);
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        position: relative;
        transition: 0.2s;
        box-shadow: 0 2px 8px rgba(74, 59, 50, 0.03);
    }

    .set-card:active {
        border-color: var(--primary);
        background: var(--light-coffee);
    }

    .set-num {
        font-size: 18px;
        font-weight: bold;
        color: var(--dark);
        margin-bottom: 5px;
    }

    .set-info {
        font-size: 13px;
        color: #9d8b80;
    }

    /* === ç­”é¢˜åŒº === */
    .quiz-area {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        background: #fff;
    }

    .progress-bar {
        height: 6px;
        background: #eee;
        border-radius: 3px;
        margin-bottom: 20px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.3s;
    }

    .question-meta {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        justify-content: space-between;
        font-size: 14px;
        color: #8d7b72;
    }

    .meta-left {
        display: flex;
        align-items: center;
    }

    .point-tag {
        font-size: 12px;
        color: #999;
        margin-left: 8px;
    }

    .source-tag {
        font-size: 12px;
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 4px;
        color: #888;
        margin-left: 8px;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 6px;
        color: white;
        font-size: 12px;
        font-weight: bold;
        margin-right: 8px;
        display: inline-block;
    }
    
    .badge-judge { background: #9d8189; }
    .badge-single { background: var(--primary); }
    .badge-multi { background: #7a9e9f; }

    .question-text {
        font-size: 18px;
        color: var(--dark);
        line-height: 1.7;
        margin-bottom: 25px;
        font-weight: 600;
    }

    .options-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-bottom: 20px;
    }

    .option-item {
        padding: 15px;
        border: 2px solid #f2f2f2;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: flex-start;
        line-height: 1.6;
        background: #fff;
        transition: 0.1s;
        color: #5d4d44;
    }

    .option-item:active {
        background-color: #fafafa;
        border-color: #e0e0e0;
    }

    /* === ç»ƒä¹ æ¨¡å¼æ ·å¼ === */
    .option-item.selected {
        border-color: var(--primary);
        background-color: var(--light-coffee);
        color: var(--primary);
        font-weight: 500;
    }
    .option-item.correct {
        border-color: var(--success);
        background-color: #f1f8e9;
        color: #33691e;
    }
    .option-item.wrong {
        border-color: var(--error);
        background-color: #fdf2f2;
        color: #8c2f2f;
    }

    .option-item .opt-tag {
        font-weight: bold;
        width: 25px;
        color: #a18e84;
        flex-shrink: 0;
        margin-top: 1px;
    }
    
    .option-item.selected .opt-tag { color: var(--primary); }
    .option-item.correct .opt-tag { color: var(--success); }
    .option-item.wrong .opt-tag { color: var(--error); }

    /* === è€ƒè¯•æ¨¡å¼é€‰ä¸­æ€ (è“è‰²) === */
    .mode-exam .option-item.selected { 
        border-color: var(--exam-selected); 
        background: var(--exam-selected-bg); 
        color: var(--exam-selected); 
        font-weight: 500;
    }
    .mode-exam .option-item.selected .opt-tag { color: var(--exam-selected); }


    /* === åº•éƒ¨æ§åˆ¶ === */
    .quiz-footer {
        padding: 15px 20px;
        border-top: 1px solid var(--border-color);
        background: #fff;
        flex-shrink: 0;
        z-index: 10;
    }

    .feedback {
        font-weight: bold;
        font-size: 16px;
        height: 24px;
        margin-bottom: 15px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    @media (max-width: 600px) {
        .controls {
            flex-direction: column-reverse;
        }

        .nav-btns {
            width: 100%;
        }

        .jump-box {
            width: 100%;
            justify-content: center;
            border-top: 1px solid #f5f5f5;
            padding-top: 10px;
        }
    }

    .nav-btns {
        display: flex;
        gap: 10px;
        flex: 1;
    }

    .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        transition: 0.2s;
        flex: 1;
        text-align: center;
    }

    .btn:active { opacity: 0.8; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: #f8f9fa; border: 1px solid #ddd; color: #555; }
    .btn-kill { background: var(--error); color: white; display: none; }

    .jump-box { display: flex; align-items: center; gap: 8px; }
    .jump-input { width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 14px; -webkit-appearance: none; color: var(--dark); }
    .jump-btn { padding: 8px 12px; background: #eee; border: none; border-radius: 6px; color: #555; font-size: 13px; }

    /* === å¼¹çª— === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(44, 34, 30, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(2px);
    }

    .modal-content {
        background: white;
        width: 600px;
        max-width: 90%;
        max-height: 85vh;
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(74, 59, 50, 0.2);
        color: var(--dark);
    }

    .modal-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        color: var(--primary);
    }

    /* å¯¼å…¥ç•Œé¢ */
    .import-layout {
        display: flex;
        flex: 1;
        gap: 15px;
        overflow: hidden;
        min-height: 200px;
        flex-direction: column;
    }

    @media (min-width: 600px) { .import-layout { flex-direction: row; } }

    .import-inputs,
    .import-preview {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow: hidden;
    }

    .import-preview {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        background: #faf9f6;
        max-height: 200px;
        overflow-y: auto;
    }

    .input-group textarea {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: monospace;
        resize: none;
        font-size: 13px;
        height: 100px;
        background: #fff;
    }
    
    .input-group label { font-size: 12px; font-weight: bold; color: #888; }

    /* éšæœºé…ç½® */
    .config-section { margin-bottom: 15px; flex-shrink: 0; }
    .set-checkbox-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 10px;
        background: #faf9f6;
        border-radius: 8px;
    }
    @media (min-width: 500px) { .set-checkbox-grid { grid-template-columns: 1fr 1fr; } }
    
    .score-config-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }
    .score-config-item {
        background: #f8f7f4;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .score-input-group { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .config-input { width: 50px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }

    /* æˆç»©å• */
    .result-card { text-align: center; padding: 10px; }
    .final-score {
        font-size: 56px;
        font-weight: 800;
        color: var(--primary);
        margin: 10px 0;
    }
    .score-detail {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        font-size: 14px;
    }
    .preview-item {
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 12px;
    }
    .preview-ans { color: var(--success); font-weight: bold; }

    /* === ç™»å½•é”å±æ ·å¼ === */
    .login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #4a3b32;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .login-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        width: 300px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }
    .login-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--dark); }
    .login-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #eee;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 16px;
        text-align: center;
        outline: none;
        transition: 0.3s;
        color: var(--dark);
    }
    .login-input:focus { border-color: var(--primary); }
    .login-btn {
        width: 100%;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
    }
    .login-error { color: var(--error); font-size: 14px; margin-top: 10px; min-height: 20px; }

    /* === é”™é¢˜åœºæ¬¡åˆ—è¡¨ === */
    .mistake-session-list { overflow-y: auto; padding: 5px; }
    .session-card {
        background: #fcfaf8; border: 1px solid var(--border-color);
        padding: 15px; border-radius: 10px; margin-bottom: 10px;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .session-card:active { background: var(--light-coffee); }
    .session-date { font-weight: bold; font-size: 14px; }
    .session-info { font-size: 12px; color: #888; margin-top: 4px; }
    .session-count { font-weight: bold; color: var(--error); background: #fff5f5; padding: 4px 8px; border-radius: 12px; font-size: 12px; }

    /* === ç­”é¢˜å¡å¼¹çª—æ ·å¼ === */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
        gap: 12px;
        padding: 10px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .card-item {
        width: 45px;
        height: 45px;
        border-radius: 50%; /* åœ†å½¢ */
        background: #f8f9fa;
        border: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        transition: 0.2s;
    }

    /* å½“å‰æ‰€åœ¨é¢˜ */
    .card-item.current {
        border-color: var(--primary);
        color: var(--primary);
        box-shadow: 0 0 0 2px var(--light-coffee);
    }

    /* å·²ä½œç­” */
    .card-item.done {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    /* è€ƒè¯•æ¨¡å¼ä¸‹çš„å·²ä½œç­” (è“è‰²ç³») */
    .mode-exam .card-item.done {
        background: #4a90e2;
        border-color: #4a90e2;
    }

    /* æ ‡è®°/æ­£ç¡®/é”™è¯¯ (é¢„ç•™æ‰©å±•ï¼Œç›®å‰åªåšå·²ç­”) */




    /* === ç­”é¢˜å¡ï¼šéæ¨¡æ€æ‚¬æµ®ä¾§è¾¹æ  === */
    #card-modal {
        /* å…³é”® 1ï¼šè®©å¤–å±‚é®ç½©â€œéšèº«â€ä¸”â€œä¸æŒ¡é¼ æ ‡â€ */
        background: transparent !important; /* å®Œå…¨é€æ˜ */
        backdrop-filter: none !important;   /* å»é™¤æ¨¡ç³Š */
        pointer-events: none;               /* è®©ç‚¹å‡»ç©¿é€ï¼Œç›´è¾¾åº•ä¸‹çš„é¢˜ç›® */
        
        /* å¸ƒå±€è°ƒæ•´ */
        justify-content: flex-end; /* é å³æ˜¾ç¤º */
        align-items: stretch;
    }

    #card-modal .modal-content {
        /* å…³é”® 2ï¼šè®©ä¾§è¾¹æ æœ¬ä½“â€œæ¢å¤â€ç‚¹å‡» */
        pointer-events: auto; 
        
        /* æ ·å¼ç¾åŒ– */
        width: 240px;            /* ç¨å¾®çª„ä¸€ç‚¹ï¼Œç•™å‡ºæ›´å¤šç©ºé—´ç»™é¢˜ç›® */
        margin: 0;               /* å»é™¤é»˜è®¤è¾¹è· */
        height: 100%;            /* å æ»¡é«˜åº¦ */
        max-height: 100%;
        border-radius: 20px 0 0 20px; /* å·¦ä¾§åœ†è§’ */
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1); /* æ·»åŠ é˜´å½±ï¼ŒåŒºåˆ†å±‚çº§ */
        background: rgba(255, 255, 255, 0.95); /* å¾®å¾®åŠé€æ˜çš„ç™½è‰²èƒŒæ™¯ */
        border-left: 1px solid var(--border-color);
        
        /* åŠ¨ç”» */
        animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    /* è°ƒæ•´ç½‘æ ¼é—´è·ï¼Œä½¿å…¶åœ¨çª„ä¾§è¾¹æ é‡Œæ›´å¥½çœ‹ */
    .card-grid {
        padding: 15px 10px;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); /* ç¨å¾®è°ƒå°æ ¼å­çš„æœ€å°å®½åº¦ */
        gap: 8px;
    }
    .card-item {
        width: 40px; height: 40px; font-size: 13px; /* ç¨å¾®è°ƒå°åœ†åœˆ */
    }
</style>
</head>
<body>

    <div id="login-modal" class="login-overlay">
        <div class="login-card">
            <div class="login-title">åˆ·é¢˜ç³»ç»Ÿç™»å½•</div>
            <input type="text" id="login-user" class="login-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="off">
            <input type="password" id="login-pwd" class="login-input" placeholder="è¯·è¾“å…¥å¯†ç " onkeyup="if(event.key==='Enter') doLogin()">
            <button class="login-btn" onclick="doLogin()">è¿›å…¥ç³»ç»Ÿ</button>
            <div id="login-msg" class="login-error"></div>
        </div>
    </div>

    <div class="container">

        <div id="view-home" class="view-section active">
            <div class="start-screen">
                <div class="home-header">
                    <div class="user-greeting">Hi, <span id="home-username">è€ƒç”Ÿ</span> ğŸ‘‹</div>
                    <div class="app-subtitle">ä¿æŒä¸“æ³¨ï¼Œä»Šå¤©ä¹Ÿè¦åŠ æ²¹ï¼</div>
                </div>
                
                <div class="menu-section">
                    <div class="menu-grid">
                        <div class="menu-card" onclick="goToSetSelection()">
                            <div class="menu-icon-box">ğŸ“š</div>
                            <div class="menu-text">
                                <div class="menu-title">æŒ‰å¥—åˆ·é¢˜</div>
                                <div class="menu-desc">é¡ºåºç»ƒä¹  Â· åŸºç¡€å·©å›º</div>
                            </div>
                        </div>
                        <div class="menu-card" onclick="openRandomConfig()">
                            <div class="menu-icon-box">ğŸ†</div>
                            <div class="menu-text">
                                <div class="menu-title">æ¨¡æ‹Ÿè€ƒè¯•</div>
                                <div class="menu-desc">éšæœºç»„å· Â· è‡ªåŠ¨æ‰“åˆ†</div>
                            </div>
                        </div>
                        <div class="menu-card card-mistake" onclick="openMistakeSelector()">
                            <div class="menu-icon-box">ğŸ–ï¸</div>
                            <div class="menu-text">
                                <div class="menu-title">é”™é¢˜æ”»åš</div>
                                <div class="menu-desc" id="mistake-count-label">0 é¢˜å¾…å¤ä¹ </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tools-section">
                    <div class="section-label">æ•°æ®ç®¡ç† & ç³»ç»Ÿ</div>
                    <div class="tools-grid">
                        <div class="tool-btn" onclick="openImportModal()">
                            <i>ğŸ“¥</i> å½•å…¥é¢˜åº“
                        </div>
                        <div class="tool-btn" onclick="exportToFile()">
                            <i>ğŸ’¾</i> å¤‡ä»½æ•°æ®
                        </div>
                        <div class="tool-btn" onclick="document.getElementById('file-input').click()">
                            <i>ğŸ“‚</i> æ¢å¤æ•°æ®
                            <input type="file" id="file-input" style="display:none" accept=".json" onchange="importFromFile(this)">
                        </div>
                        <div class="tool-btn tool-lock" onclick="doLogout()">
                            <i>ğŸ”’</i> é”å®šç¦»å¼€
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-select" class="view-section">
            <div class="select-header">
                <div class="back-icon" onclick="goHome()">â¬…ï¸</div>
                <div class="header-title">é€‰æ‹©ç»ƒä¹ å¥—é¢˜</div>
                <div style="width:24px;"></div>
            </div>
            <div class="set-list" id="set-list-container"></div>
        </div>

        <div id="view-quiz" class="view-section">
            <div class="quiz-header">
                <div style="display:flex; align-items:center; overflow:hidden; flex:1;">
                    <div class="back-icon" onclick="goHome()">â¬…ï¸</div>
                    <span id="quiz-mode-title" class="header-title">ç»ƒä¹ </span>
                </div>
                <div id="timer-display" class="timer-badge">00:00</div>
                <div style="display:flex; align-items:center; flex-shrink:0;">
                    <div id="live-score-board" class="score-board" style="display:none;">0</div>
                    <!-- ä¿®å¤ç‚¹ï¼šæ·»åŠ äº† ID btn-top-finish -->
                    <button class="exit-btn" id="btn-top-finish" onclick="finishExam()">äº¤å·</button>
                </div>
            </div>
            <div class="quiz-area">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="question-meta">
                    <div class="meta-left">
                        <span id="q-type" class="badge badge-single">å•é€‰</span>
                        <span id="q-point-tag" class="point-tag"></span>
                        <span id="q-source-tag" class="source-tag" style="display:none;"></span>
                    </div>
                    <span id="q-index" class="q-number">1/100</span>
                </div>
                <div id="q-text" class="question-text">åŠ è½½ä¸­...</div>
                <div id="q-options" class="options-list"></div>
            </div>
            <div class="quiz-footer">
                <div id="feedback" class="feedback"></div>
                <div class="controls">
                    <div class="nav-btns">
                        <button id="btn-kill" class="btn btn-kill" onclick="killMistake()">ğŸ—‘ï¸ ç§»é™¤</button>
                        <button class="btn btn-outline" onclick="nav(-1)">ä¸Šä¸€é¢˜</button>
                        <button id="btn-submit" class="btn btn-submit" onclick="submitAnswer()">æäº¤</button>
                        <button id="btn-next" class="btn btn-primary" onclick="nav(1)">ä¸‹ä¸€é¢˜</button>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                         <button class="btn btn-outline" style="padding:8px 15px; font-size:13px; white-space: nowrap;" onclick="openQuestionCard()">
                            ğŸ”¢ ç­”é¢˜å¡
                         </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="import-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>é¢˜åº“ç®¡ç†</span>
                <button style="background:none; border:none; font-size:20px; color:#999;" onclick="closeImportModal()">Ã—</button>
            </div>
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center;">
                    <span style="font-size:14px; font-weight:bold;">ç¬¬</span>
                    <input type="number" id="import-set-num" value="1" min="1" style="margin:0 5px; width:50px; padding:5px; border:1px solid #ddd; border-radius:4px; text-align:center;" oninput="onSetNumChange()">
                    <span style="font-size:14px; font-weight:bold;">å¥—</span>
                </div>
                <button style="font-size:12px; color:red; border:1px solid red; background:none; padding:4px 8px; border-radius:4px;" onclick="deleteCurrentSet()">åˆ é™¤æ­¤å¥—</button>
            </div>
            <div class="import-layout">
                <div class="import-inputs">
                    <div class="input-group">
                        <label>é¢˜ç›®æ–‡æœ¬ (ç²˜è´´):</label>
                        <textarea id="raw-questions" placeholder="ä¾‹: 1. é¢˜ç›®... A. é€‰é¡¹..."></textarea>
                    </div>
                    <div class="input-group">
                        <label>ç­”æ¡ˆæ–‡æœ¬ (ç²˜è´´):</label>
                        <textarea id="raw-answers" placeholder="ä¾‹: 1~5: A B C..."></textarea>
                    </div>
                </div>
                <div class="import-preview">
                    <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">é¢„è§ˆ (<span id="preview-count">0</span>é¢˜)</div>
                    <div id="preview-list"></div>
                </div>
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-primary" style="width:100%" onclick="importData()">ä¿å­˜ / æ›´æ–°</button>
            </div>
        </div>
    </div>

    <div id="config-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span>è€ƒè¯•è®¾ç½®</span>
                <button style="background:none; border:none; font-size:20px; color:#999;" onclick="closeRandomConfig()">Ã—</button>
            </div>
            <div class="config-section">
                <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">é¢˜åº“æ¥æº</div>
                <div id="set-selection-area" class="set-checkbox-grid"></div>
                <div style="margin-top:5px; text-align:right;">
                    <a href="javascript:toggleAllSets(true)" style="font-size:12px;color:var(--primary);margin-right:10px;">å…¨é€‰</a>
                    <a href="javascript:toggleAllSets(false)" style="font-size:12px;color:#999;">æ¸…ç©º</a>
                </div>
            </div>
            <div class="config-section">
                <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">é¢˜é‡ä¸åˆ†å€¼</div>
                <div class="score-config-grid">
                    <div class="score-config-item">
                        <span style="font-weight:bold; font-size:13px;">åˆ¤æ–­</span>
                        <div class="score-input-group"><input type="number" id="cfg-judge" class="config-input" value="20" oninput="updateTotal()">é¢˜</div>
                        <div class="score-input-group"><input type="number" id="pts-judge" class="config-input" value="1" oninput="updateTotal()">åˆ†</div>
                    </div>
                    <div class="score-config-item">
                        <span style="font-weight:bold; font-size:13px;">å•é€‰</span>
                        <div class="score-input-group"><input type="number" id="cfg-single" class="config-input" value="60" oninput="updateTotal()">é¢˜</div>
                        <div class="score-input-group"><input type="number" id="pts-single" class="config-input" value="1" oninput="updateTotal()">åˆ†</div>
                    </div>
                    <div class="score-config-item">
                        <span style="font-weight:bold; font-size:13px;">å¤šé€‰</span>
                        <div class="score-input-group"><input type="number" id="cfg-multi" class="config-input" value="20" oninput="updateTotal()">é¢˜</div>
                        <div class="score-input-group"><input type="number" id="pts-multi" class="config-input" value="1" oninput="updateTotal()">åˆ†</div>
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">æ—¶é—´é™åˆ¶</div>
                <div class="score-config-item">
                    <span style="font-size:13px;">è€ƒè¯•æ—¶é•¿ (åˆ†é’Ÿ)</span>
                    <div class="score-input-group">
                        <input type="number" id="cfg-duration" class="config-input" value="90" placeholder="0ä¸é™">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div style="font-size:12px; color:#999; margin-top:5px;">* è®¾ç½®ä¸º 0 æˆ–ç©ºåˆ™ä¸é™åˆ¶æ—¶é—´</div>
            </div>

            <div class="total-badge" style="text-align: center; margin: 10px 0;">
                æ€»åˆ†ï¼š<span id="cfg-total-score" style="color:var(--error); font-size:18px;">--</span> <span style="font-size:12px; color:#666;">(å…± <span id="cfg-total-count">--</span> é¢˜)</span>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="startRandomExam()">å¼€å§‹è€ƒè¯•</button>
        </div>
    </div>

    <div id="mistake-select-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>é”™é¢˜æ”»åš - é€‰æ‹©èŒƒå›´</span>
                <button style="background:none; border:none; font-size:24px; color:#999;" onclick="closeMistakeSelector()">Ã—</button>
            </div>
            <div style="margin-bottom:10px;">
                <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="startAllMistakes()">å¤ä¹ æ‰€æœ‰é”™é¢˜ (å…± <span id="total-mistakes-num">0</span> é¢˜)</button>
                <div style="font-size:12px; color:#888; margin-bottom:5px;">æˆ–é€‰æ‹©å•æ¬¡è€ƒè¯•è®°å½•ï¼š</div>
            </div>
            <div id="mistake-session-list" class="mistake-session-list"></div>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-content" style="width: 320px; height: auto; align-items: center;">
            <div class="modal-header" style="width:100%; justify-content:center;">è€ƒè¯•ç»“æŸ</div>
            <div class="result-card" style="width:100%">
                <div style="font-size:14px; color:#666;">æœ€ç»ˆå¾—åˆ†</div>
                <div class="final-score" id="res-score">0</div>
                <div class="score-detail">
                    <div>å¯¹:<span id="res-correct" style="color:var(--success);font-weight:bold;margin-left:4px;">0</span></div>
                    <div>é”™:<span id="res-wrong" style="color:var(--error);font-weight:bold;margin-left:4px;">0</span></div>
                    <div>ç©º:<span id="res-skipped" style="color:#999;font-weight:bold;margin-left:4px;">0</span></div>
                </div>
                <div style="font-size:13px; color:#888; margin-bottom:15px;" id="res-info"></div>
                <div style="font-size:13px; color:#888; margin-bottom:10px; background:#f9f9f9; padding:5px; border-radius:5px;">
                    è€—æ—¶: <span id="res-time-taken" style="font-weight:bold;color:var(--dark)">00:00</span>
                </div>

                <div style="font-size:12px; color:var(--error); margin-bottom:20px; display:none; background:#fff5f5; padding:8px; border-radius:6px;" id="res-mistake-hint"></div>
                <button class="btn btn-primary" style="width:100%" onclick="closeResultModal()">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>

    <div id="card-modal" class="modal-overlay" onclick="if(event.target === this) closeQuestionCard()">
        <div class="modal-content">
            <div class="modal-header">
                <span>ç­”é¢˜å¡</span>
                <button style="background:none; border:none; font-size:24px; color:#999;" onclick="closeQuestionCard()">Ã—</button>
            </div>
            <div style="padding: 0 10px 10px;">
                <div style="font-size:12px; color:#888; margin-bottom:10px; display:flex; gap:15px;">
                    <span><span style="display:inline-block;width:10px;height:10px;border:1px solid #ddd;border-radius:50%;margin-right:4px;"></span>æœªåš</span>
                    <span><span style="display:inline-block;width:10px;height:10px;background:var(--primary);border-radius:50%;margin-right:4px;"></span>å·²åš</span>
                    <span><span style="display:inline-block;width:10px;height:10px;border:2px solid var(--primary);border-radius:50%;margin-right:4px;"></span>å½“å‰</span>
                </div>
            </div>
            <div id="question-card-grid" class="card-grid"></div>
        </div>
    </div>

<script>
    // === å…¨å±€æ•°æ® ===
    var database = { 
        mistakes: [], 
        examHistory: [] 
    };
    
    var currentQuizList = []; 
    var currentIndex = 0; 
    var userAnswers = {}; 
    
    var mode = "practice"; // practice, exam, mistake
    var timerInterval = null; 
    var secondsElapsed = 0; 
    var secondsRemaining = 0;

    // === æ¨¡æ‹Ÿ/æ¼”ç¤ºæ•°æ® (é˜²æ­¢æœ¬åœ°æ— æ•°æ®æ—¶æ˜¾ç¤ºç©ºç™½) ===
    var demoData = {
        "1": [
            {id:1, type:"å•é€‰é¢˜", text:"ä¸­å›½å…±äº§å…šæˆç«‹çš„æ—¶é—´æ˜¯ï¼Ÿ", options:["A. 1919å¹´", "B. 1921å¹´", "C. 1949å¹´", "D. 1978å¹´"], answer:"B", point:1},
            {id:2, type:"å•é€‰é¢˜", text:"ã€Šæœ¬è‰çº²ç›®ã€‹çš„ä½œè€…æ˜¯ï¼Ÿ", options:["A. åä½—", "B. ææ—¶ç", "C. æ‰é¹Š", "D. å¼ ä»²æ™¯"], answer:"B", point:1},
            {id:3, type:"åˆ¤æ–­é¢˜", text:"åœ°çƒå›´ç»•æœˆçƒè½¬ã€‚", options:["A. å¯¹", "B. é”™"], answer:"B", point:1},
            {id:4, type:"å¤šé€‰é¢˜", text:"ä»¥ä¸‹å±äºå››å¤§å‘æ˜çš„æ˜¯ï¼Ÿ", options:["A. é€ çº¸æœ¯", "B. æŒ‡å—é’ˆ", "C. ç«è¯", "D. ç®—ç›˜"], answer:"ABC", point:2},
            {id:5, type:"å•é€‰é¢˜", text:"1+1ç­‰äºå‡ ï¼Ÿ", options:["A. 1", "B. 2", "C. 3", "D. 4"], answer:"B", point:1}
        ]
    };

    // === åˆå§‹åŒ–ï¼šè¯»å–æ•°æ® ===
    window.onload = function() {
        // 1. å…ˆå°è¯•è¯»å–æœ¬åœ°ç¼“å­˜ï¼ˆä¸ºäº†ä¿ç•™ç”¨æˆ·çš„åšé¢˜è¿›åº¦ã€é”™é¢˜æœ¬ï¼‰
        var saved = localStorage.getItem('exam_db_v2');
        if (saved) { 
            try { 
                database = JSON.parse(saved);
                // ç¡®ä¿åŸºç¡€ç»“æ„å­˜åœ¨
                if (!database.mistakes) database.mistakes = [];
                if (!database.examHistory) database.examHistory = [];
            } catch(e) { console.error("è¯»å–ç¼“å­˜å¤±è´¥", e); } 
        }

        // 2. ã€å…³é”®æ–°å¢ã€‘ä¸»åŠ¨å»è¯·æ±‚ GitHub ä¸Šçš„ JSON æ–‡ä»¶
        // è¯·æŠŠä¸‹é¢çš„ 'tiku.json' æ”¹æˆä½ ä¸Šä¼ åˆ° GitHub çš„é‚£ä¸ªæ–‡ä»¶åï¼
        fetch('./mayuantiku.json') 
            .then(response => {
                if (!response.ok) {
                    throw new Error("HTTP error " + response.status);
                }
                return response.json();
            })
            .then(serverData => {
                console.log("æˆåŠŸåŠ è½½æœåŠ¡å™¨æ•°æ®:", serverData);
                
                let hasNewData = false;
                
                // 3. å°† JSON æ–‡ä»¶é‡Œçš„æ•°æ®åˆå¹¶åˆ°å½“å‰çš„ database ä¸­
                // é€»è¾‘ï¼šéå† JSON é‡Œçš„æ¯ä¸€å¥—é¢˜ï¼Œå¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œæˆ–è€…æƒ³è¦å¼ºåˆ¶è¦†ç›–ï¼Œå°±åœ¨è¿™é‡Œæ“ä½œ
                for (let key in serverData) {
                    // å¿½ç•¥ JSON é‡Œå¯èƒ½è‡ªå¸¦çš„ç³»ç»Ÿå­—æ®µ
                    if (key === 'mistakes' || key === 'examHistory') continue;
                    
                    // åªè¦æ–‡ä»¶é‡Œæœ‰è¿™å¥—é¢˜ï¼Œå°±æ›´æ–°è¿›å»ï¼ˆè¿™æ ·ä½ ä¿®æ”¹ JSON åï¼Œç”¨æˆ·åˆ·æ–°ä¹Ÿèƒ½çœ‹åˆ°æ–°é¢˜ï¼‰
                    database[key] = serverData[key];
                    hasNewData = true;
                }

                // 4. å¦‚æœæœ‰æ–°æ•°æ®ï¼Œä¿å­˜å¹¶åˆ·æ–°ç•Œé¢
                if (hasNewData) {
                    saveData(); // å­˜å…¥æœ¬åœ°ç¼“å­˜
                    updateHomeStats(); // åˆ·æ–°æ˜¾ç¤ºçš„é¢˜æ•°
                    // å¯é€‰ï¼šç»™ä¸ªæç¤º
                    // alert("å·²è‡ªåŠ¨æ›´æ–°é¢˜åº“ï¼"); 
                }
            })
            .catch(err => {
                console.log("æœªæ‰¾åˆ°åœ¨çº¿é¢˜åº“æ–‡ä»¶ï¼Œæˆ–æ–‡ä»¶åä¸å¯¹:", err);
                
                // å¦‚æœæ—¢æ²¡æœ‰æœ¬åœ°ç¼“å­˜ï¼Œä¹Ÿæ²¡åŠ è½½åˆ°æ–‡ä»¶ï¼Œæ‰ä½¿ç”¨æ¼”ç¤ºæ•°æ®
                var validKeys = Object.keys(database).filter(k => k !== 'mistakes' && k !== 'examHistory');
                if (validKeys.length === 0) {
                     database["1"] = demoData["1"];
                     console.log("åŠ è½½å†…ç½®æ¼”ç¤ºæ•°æ®");
                     saveData();
                     updateHomeStats();
                }
            });

        // å…ˆåˆ·æ–°ä¸€æ¬¡ç•Œé¢ï¼ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼‰
        updateHomeStats();
    }

    function saveData() { 
        localStorage.setItem('exam_db_v2', JSON.stringify(database)); 
        updateHomeStats(); 
    }

    function updateHomeStats() { 
        document.getElementById('mistake-count-label').innerText = database.mistakes.length + " é¢˜å¾…å¤ä¹ "; 
    }

    // === è§†å›¾åˆ‡æ¢ ===
    function showView(id) { 
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
    }

    function goHome() { 
        if (mode === 'exam' && Object.keys(userAnswers).length > 0 && !confirm("è€ƒè¯•ä¸­é€”é€€å‡ºå°†ä¸ä¿å­˜è¿›åº¦ï¼Œç¡®å®šï¼Ÿ")) return; 
        stopTimer(); 
        showView('view-home'); 
    }

    // === æ ¸å¿ƒé€»è¾‘ï¼šå¼€å§‹ç­”é¢˜ ===
    function startQuiz(list, title, m, duration = 0) {
        currentQuizList = list; 
        currentIndex = 0; 
        mode = m; 
        userAnswers = {}; 
        secondsElapsed = 0;
        
        document.getElementById('quiz-mode-title').innerText = title; 
        document.getElementById('view-quiz').className = 'view-section active mode-' + m; 
        
        // ä¿®å¤ï¼šå¢åŠ äº†å¯¹ null å…ƒç´ çš„ä¿æŠ¤
        var btnTop = document.getElementById('btn-top-finish');
        var btnSubmit = document.getElementById('btn-submit');
        var btnNext = document.getElementById('btn-next');
        var btnKill = document.getElementById('btn-kill');

        if (mode === 'exam') {
            if(btnTop) btnTop.style.display = 'block'; 
            if(btnKill) btnKill.style.display = 'none'; 
            if(btnSubmit) btnSubmit.style.display = 'none'; 
            if(btnNext) btnNext.style.display = 'block'; 
            startTimer('down', duration); 
        } else {
            if(btnTop) btnTop.style.display = 'none'; 
            if(btnNext) btnNext.style.display = 'none'; 
            if(btnSubmit) btnSubmit.style.display = 'block'; 
            if (mode === 'mistake' && btnKill) btnKill.style.display = 'none'; 
            startTimer('up'); 
        }
        showView('view-quiz'); 
        renderQuestion();
    }

    // === æ¸²æŸ“é¢˜ç›® ===
    function renderQuestion() {
        var q = currentQuizList[currentIndex];
        var userAnswer = userAnswers[currentIndex] || "";
        
        document.getElementById('q-index').innerText = (currentIndex + 1) + "/" + currentQuizList.length;
        document.getElementById('progress-fill').style.width = ((currentIndex + 1) / currentQuizList.length * 100) + "%";
        document.getElementById('q-type').className = 'badge ' + (q.type === 'åˆ¤æ–­é¢˜' ? 'badge-judge' : (q.type === 'å¤šé€‰é¢˜' ? 'badge-multi' : 'badge-single'));
        document.getElementById('q-type').innerText = q.type.replace('é¢˜','');
        document.getElementById('q-text').innerText = q.id + ". " + q.text;
        
        var optsDiv = document.getElementById('q-options'); 
        optsDiv.innerHTML = '';
        var opts = (q.type === 'åˆ¤æ–­é¢˜' && (!q.options || q.options.length===0)) ? ["A. å¯¹", "B. é”™"] : q.options;
        
        opts.forEach(o => {
            var key = o.charAt(0);
            var el = document.createElement('div'); 
            el.className = 'option-item';
            el.innerHTML = `<span class="opt-tag">${key}</span> ${o.substring(2)}`;
            
            if (userAnswer.includes(key)) el.classList.add('selected');
            
            if (mode !== 'exam' && userAnswer) { 
                if (q.answer.includes(key)) el.classList.add('correct'); 
                if (userAnswer.includes(key) && !q.answer.includes(key)) el.classList.add('wrong'); 
            }
            
            el.onclick = () => handleOptionClick(el, key, q.type); 
            optsDiv.appendChild(el);
        });
        
        var btnNext = document.getElementById('btn-next');
        var btnSubmit = document.getElementById('btn-submit');
        var feedback = document.getElementById('feedback');
        feedback.innerText = "";
        
        if (mode === 'exam') {
            btnNext.innerText = (currentIndex === currentQuizList.length - 1) ? "äº¤å·" : "ä¸‹ä¸€é¢˜"; 
            btnNext.onclick = (currentIndex === currentQuizList.length - 1) ? finishExam : () => nav(1); 
        } else {
            if (userAnswer) { 
                var isRight = (userAnswer === q.answer); 
                feedback.innerHTML = isRight ? "<span style='color:var(--success)'>å›ç­”æ­£ç¡®</span>" : `ç­”æ¡ˆ: ${q.answer}`; 
                btnSubmit.style.display = 'none'; 
                btnNext.style.display = 'block'; 
                btnNext.innerText = "ä¸‹ä¸€é¢˜"; 
                if (mode === 'mistake' && isRight) document.getElementById('btn-kill').style.display = 'block'; 
            } else { 
                if (q.type === 'å¤šé€‰é¢˜') {
                    btnSubmit.style.display = 'block';
                } else {
                    btnSubmit.style.display = 'none'; 
                }
                btnNext.style.display = 'none'; 
                document.getElementById('btn-kill').style.display = 'none'; 
            }
        }
    }

    function handleOptionClick(el, key, type) {
        if (mode !== 'exam' && userAnswers[currentIndex]) return;
        
        var currentAns = userAnswers[currentIndex] || "";
        
        if (type === 'å¤šé€‰é¢˜') { 
            if (currentAns.includes(key)) { 
                currentAns = currentAns.replace(key, ''); 
                el.classList.remove('selected'); 
            } else { 
                currentAns += key; 
                el.classList.add('selected'); 
            } 
            userAnswers[currentIndex] = currentAns.split('').sort().join(''); 
        } else { 
            document.querySelectorAll('.option-item').forEach(d => d.classList.remove('selected')); 
            el.classList.add('selected'); 
            userAnswers[currentIndex] = key; 
            
            if (mode !== 'exam') {
                submitAnswer();
            }
        }
    }

    function submitAnswer() {
        var ans = userAnswers[currentIndex]; 
        if (!ans) return;
        var q = currentQuizList[currentIndex];
        var isCorrect = (ans === q.answer);
        
        if (!isCorrect && mode === 'practice') { 
            if (!database.mistakes.some(m => m.text === q.text)) { 
                database.mistakes.push(q); 
                saveData(); 
            } 
        }
        renderQuestion();
    }

    function nav(dir) { 
        if (dir === 1 && currentIndex < currentQuizList.length - 1) { currentIndex++; renderQuestion(); } 
        else if (dir === -1 && currentIndex > 0) { currentIndex--; renderQuestion(); } 
    }
    
    function jumpTo() { 
        var val = parseInt(document.getElementById('jump-val').value); 
        if (val >= 1 && val <= currentQuizList.length) { currentIndex = val - 1; renderQuestion(); } 
    }
    
    // === ç­”é¢˜å¡é€»è¾‘ ===

    function openQuestionCard() {
        var grid = document.getElementById('question-card-grid');
        grid.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
        
        // åŠ¨æ€ç”Ÿæˆæ–¹æ ¼
        currentQuizList.forEach((q, index) => {
            var item = document.createElement('div');
            item.className = 'card-item';
            item.innerText = index + 1;
            
            // çŠ¶æ€åˆ¤æ–­
            var isCurrent = (index === currentIndex);
            var isAnswered = userAnswers[index] !== undefined && userAnswers[index] !== "";
            
            if (isCurrent) {
                item.classList.add('current');
            } else if (isAnswered) {
                item.classList.add('done');
            }
            
            // å¦‚æœæ˜¯è€ƒè¯•æ¨¡å¼ï¼Œéœ€è¦æŠŠå®¹å™¨æ ‡è®°ä¸€ä¸‹ï¼Œä»¥ä¾¿CSSå˜è‰²
            if (mode === 'exam') {
                grid.classList.add('mode-exam');
            } else {
                grid.classList.remove('mode-exam');
            }

            // ç‚¹å‡»äº‹ä»¶
            item.onclick = function() {
                currentIndex = index;
                renderQuestion();
                closeQuestionCard();
            };
            
            grid.appendChild(item);
        });
        
        document.getElementById('card-modal').style.display = 'flex';
    }

    function closeQuestionCard() {
        document.getElementById('card-modal').style.display = 'none';
    }


    function finishExam() {
        stopTimer(); 
        
        var correct = 0, wrong = 0, score = 0, currentMistakes = [];
        
        currentQuizList.forEach((q, idx) => { 
            var uAns = userAnswers[idx] || ""; 
            if (uAns === q.answer) { 
                correct++; 
                score += (q.point || 1); 
            } else { 
                wrong++; 
                currentMistakes.push(Object.assign({}, q)); 
                if (!database.mistakes.some(m => m.text === q.text)) database.mistakes.push(q); 
            } 
        });
        
        if (!database.examHistory) database.examHistory = [];

        if (currentMistakes.length > 0 && mode === 'exam') { 
            var record = { 
                id: Date.now(), 
                date: new Date().toLocaleString(), 
                score: score, 
                mistakes: currentMistakes 
            }; 
            database.examHistory.unshift(record); 
            if (database.examHistory.length > 20) database.examHistory.pop(); 
            saveData(); 
        }
        
        document.getElementById('res-score').innerText = (mode === 'exam') ? score : "--"; 
        document.getElementById('res-correct').innerText = correct; 
        document.getElementById('res-wrong').innerText = wrong; 
        document.getElementById('res-time-taken').innerText = "è€—æ—¶: " + formatTime(secondsElapsed);
        
        var hintDiv = document.getElementById('res-mistake-hint');
        if (mode === 'exam' && currentMistakes.length > 0) { 
            hintDiv.style.display = 'block'; 
            hintDiv.innerText = `å·²å°† ${currentMistakes.length} é“é”™é¢˜ä¿å­˜è‡³[é”™é¢˜æ”»åš]ï¼Œè¯·å‰å¾€æŸ¥çœ‹è§£æã€‚`; 
        } else hintDiv.style.display = 'none';
        
        document.getElementById('result-modal').style.display = 'flex';
    }

    function startTimer(dir, limitMins) { 
        stopTimer(); 
        var display = document.getElementById('timer-display'); 
        display.classList.remove('urgent'); 
        
        if (dir === 'down' && limitMins > 0) { 
            secondsRemaining = limitMins * 60; 
            display.innerText = formatTime(secondsRemaining); 
            timerInterval = setInterval(() => { 
                secondsRemaining--; 
                secondsElapsed++; 
                display.innerText = formatTime(secondsRemaining); 
                if (secondsRemaining <= 60) display.classList.add('urgent'); 
                if (secondsRemaining <= 0) { 
                    finishExam(); 
                    alert("æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨äº¤å·ï¼"); 
                } 
            }, 1000); 
        } else { 
            secondsElapsed = 0; 
            display.innerText = "00:00"; 
            timerInterval = setInterval(() => { 
                secondsElapsed++; 
                display.innerText = formatTime(secondsElapsed); 
            }, 1000); 
        } 
    }
    
    function stopTimer() { clearInterval(timerInterval); }
    
    function formatTime(s) { 
        var m = Math.floor(s/60); 
        var sec = s%60; 
        return (m<10?"0"+m:m) + ":" + (sec<10?"0"+sec:sec); 
    }
    
    function shuffle(a) { return a.sort(() => Math.random() - 0.5); }

    function openMistakeSelector() {
        if (database.mistakes.length === 0 && (!database.examHistory || database.examHistory.length === 0)) { 
            alert("æš‚æ— é”™é¢˜è®°å½•"); 
            return; 
        }
        document.getElementById('total-mistakes-num').innerText = database.mistakes.length; 
        var listDiv = document.getElementById('mistake-session-list'); 
        listDiv.innerHTML = "";
        
        if (database.examHistory) {
            database.examHistory.forEach((record, index) => { 
                var div = document.createElement('div'); 
                div.className = 'session-card'; 
                div.innerHTML = `<div><div class="session-date">ğŸ“… ${record.date}</div><div class="session-info">å¾—åˆ†: ${record.score}</div></div><div class="session-count">${record.mistakes.length} é”™é¢˜</div>`; 
                div.onclick = () => startMistakeSession(index); 
                listDiv.appendChild(div); 
            });
        }
        document.getElementById('mistake-select-modal').style.display = 'flex';
    }
    
    function closeMistakeSelector() { document.getElementById('mistake-select-modal').style.display = 'none'; }
    
    function startAllMistakes() { 
        if (database.mistakes.length === 0) return; 
        closeMistakeSelector(); 
        startQuiz(database.mistakes, "å…¨é‡é”™é¢˜æ”»åš", "mistake"); 
    }
    
    function startMistakeSession(index) { 
        var record = database.examHistory[index]; 
        if (!record) return; 
        closeMistakeSelector(); 
        startQuiz(record.mistakes, "é”™é¢˜å›é¡¾ (" + record.date.split(' ')[0] + ")", "mistake"); 
    }
    
    function killMistake() { 
        var q = currentQuizList[currentIndex]; 
        database.mistakes = database.mistakes.filter(m => m.text !== q.text); 
        saveData(); 
        alert("å·²ä»æ€»é”™é¢˜åº“ä¸­ç§»é™¤"); 
        nav(1); 
    }
    
    // === è€ƒè¯•é…ç½® ===
    function openRandomConfig() { document.getElementById('config-modal').style.display = 'flex'; renderSetCheckboxes(); updateTotal(); }
    function closeRandomConfig() { document.getElementById('config-modal').style.display = 'none'; }
    
    function renderSetCheckboxes() { 
        var area = document.getElementById('set-selection-area'); 
        area.innerHTML = ''; 
        var keys = Object.keys(database).filter(k => k !== 'mistakes' && k !== 'examHistory').sort((a,b)=>parseInt(a)-parseInt(b)); 
        keys.forEach(k => { 
            var d = document.createElement('label'); 
            d.style.display="flex"; d.style.alignItems="center"; d.style.fontSize="13px"; 
            d.innerHTML = `<input type="checkbox" value="${k}" checked onchange="updateTotal()"> ç¬¬${k}å¥—`; 
            area.appendChild(d); 
        }); 
    }
    
    function toggleAllSets(state) { 
        document.querySelectorAll('#set-selection-area input').forEach(c => c.checked = state); 
        updateTotal(); 
    }
    
    function updateTotal() { 
        var j=v('cfg-judge'), s=v('cfg-single'), m=v('cfg-multi'), jp=v('pts-judge'), sp=v('pts-single'), mp=v('pts-multi'); 
        document.getElementById('cfg-total-count').innerText = (parseInt(j)+parseInt(s)+parseInt(m)); 
        document.getElementById('cfg-total-score').innerText = (j*jp + s*sp + m*mp); 
    }
    
    function v(id) { return parseFloat(document.getElementById(id).value) || 0; }
    
    function startRandomExam() {
        var sets = []; 
        document.querySelectorAll('#set-selection-area input:checked').forEach(c => sets.push(c.value)); 
        if (sets.length===0) { alert("è¯·é€‰æ‹©é¢˜åº“"); return; }
        
        var pool = { j:[], s:[], m:[] }, jp=v('pts-judge'), sp=v('pts-single'), mp=v('pts-multi');
        sets.forEach(k => { 
            database[k].forEach(q => { 
                var newQ = Object.assign({}, q, {source: "ç¬¬"+k+"å¥—"}); 
                if (q.type==='åˆ¤æ–­é¢˜') { newQ.point=jp; pool.j.push(newQ); } 
                else if (q.type==='å•é€‰é¢˜') { newQ.point=sp; pool.s.push(newQ); } 
                else if (q.type==='å¤šé€‰é¢˜') { newQ.point=mp; pool.m.push(newQ); } 
            }); 
        });
        
        var jc=v('cfg-judge'), sc=v('cfg-single'), mc=v('cfg-multi');
        // ä¿®æ­£ï¼šç¡®ä¿ä¸ä¼šè¯·æ±‚è¶…è¿‡é¢˜åº“æ•°é‡çš„é¢˜ç›®
        var list = [].concat(
            shuffle(pool.j).slice(0, Math.min(jc, pool.j.length)), 
            shuffle(pool.s).slice(0, Math.min(sc, pool.s.length)), 
            shuffle(pool.m).slice(0, Math.min(mc, pool.m.length))
        );
        
        if(list.length===0) { alert("æ²¡æœ‰è¶³å¤Ÿçš„é¢˜ç›®"); return; } 
        list.forEach((q,i) => q.id = i+1); 
        
        var duration = parseInt(document.getElementById('cfg-duration').value) || 0; 
        closeRandomConfig(); 
        startQuiz(list, "æ¨¡æ‹Ÿè€ƒè¯•", "exam", duration);
    }

    // === ç™»å½•é€»è¾‘ ===
    const APP_USER = "ycaviar", APP_PWD = "060202";
    
    // ä¿®æ”¹åçš„åˆå§‹åŒ–å‡½æ•°ï¼šæ¯æ¬¡åŠ è½½é¡µé¢éƒ½å¼ºåˆ¶é‡ç½®
    (function initLogin() {
        // 1. å¼ºåˆ¶æ¸…é™¤æµè§ˆå™¨ç¼“å­˜çš„ç™»å½•çŠ¶æ€
        sessionStorage.removeItem('is_logged_in');
        
        // 2. å¼ºåˆ¶æ˜¾ç¤ºç™»å½•å¼¹çª—
        document.getElementById('login-modal').style.display = 'flex';
        
        // 3. æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆæå‡ä½“éªŒï¼Œé˜²æ­¢çœ‹åˆ°ä¸Šæ¬¡å¡«å†™çš„æ®‹ç•™ï¼‰
        document.getElementById('login-user').value = "";
        document.getElementById('login-pwd').value = "";
        
        // é‡ç½®é¦–é¡µçš„ç”¨æˆ·åä¸ºé»˜è®¤å€¼ï¼ˆç›´åˆ°ç™»å½•æˆåŠŸæ‰æ˜¾ç¤ºçœŸåï¼‰
        document.getElementById('home-username').innerText = "è€ƒç”Ÿ";
    })();
    
    function doLogin() { 
        if(document.getElementById('login-user').value === APP_USER && document.getElementById('login-pwd').value === APP_PWD) { 
            // ç™»å½•æˆåŠŸï¼Œå†™å…¥çŠ¶æ€ï¼ˆä»…ç”¨äºæœ¬æ¬¡ä¼šè¯ä¿æŒï¼Œåˆ·æ–°åä¼šè¢«ä¸Šé¢çš„ initLogin æ¸…é™¤ï¼‰
            sessionStorage.setItem('is_logged_in', 'true');
            document.getElementById('login-modal').style.display='none'; 
            document.getElementById('home-username').innerText = APP_USER; 
        } else { 
            document.getElementById('login-msg').innerText = "è´¦å·æˆ–å¯†ç é”™è¯¯"; 
        } 
    }

    // === å…¶ä»–ç•Œé¢é€»è¾‘ ===
    function goToSetSelection() { 
        var c = document.getElementById('set-list-container'); 
        c.innerHTML=''; 
        var keys = Object.keys(database).filter(k=>k!=='mistakes'&&k!=='examHistory').sort((a,b)=>parseInt(a)-parseInt(b)); 
        if(keys.length===0) c.innerHTML='<div style="text-align:center;color:#999;grid-column:1/-1">æš‚æ— é¢˜åº“</div>'; 
        keys.forEach(k => { 
            var d = document.createElement('div'); 
            d.className='set-card'; 
            d.innerHTML=`<div class="set-num">ç¬¬ ${k} å¥—</div><div class="set-info">${database[k].length} é¢˜</div>`; 
            d.onclick=()=>startQuiz(database[k], "ç¬¬"+k+"å¥—ç»ƒä¹ ", "practice"); 
            c.appendChild(d); 
        }); 
        showView('view-select'); 
    }
    
    function closeResultModal() { 
        document.getElementById('result-modal').style.display='none'; 
        showView('view-home'); 
    }
    
    function openImportModal() { document.getElementById('import-modal').style.display='flex'; onSetNumChange(); }
    function closeImportModal() { document.getElementById('import-modal').style.display='none'; }
    
    function onSetNumChange() {
        var num = document.getElementById('import-set-num').value;
        var list = database[num] || [];
        document.getElementById('preview-count').innerText = list.length;
        document.getElementById('preview-list').innerHTML = list.length ? "å·²å­˜åœ¨æ•°æ®ï¼Œä¿å­˜å°†è¦†ç›–" : "æš‚æ— æ•°æ®";
    }
    
    function deleteCurrentSet() {
        var num = document.getElementById('import-set-num').value;
        if (confirm("åˆ é™¤ç¬¬" + num + "å¥—?")) { delete database[num]; saveData(); onSetNumChange(); }
    }

    function importData() { 
        var set = document.getElementById('import-set-num').value, qT = document.getElementById('raw-questions').value, aT = document.getElementById('raw-answers').value; 
        if (!qT || !aT) { alert("è¯·è¾“å…¥å†…å®¹"); return; } 
        
        var ansMap = {}; 
        aT.split('\n').forEach(l => { 
            var p = l.indexOf(':'); if (p < 0) return; 
            var left = l.substring(0, p).trim(), right = l.substring(p + 1).trim(), s = parseInt(left), e = parseInt(left); 
            if (left.indexOf('~') > 0) { var pts = left.split('~'); s = parseInt(pts[0]); e = parseInt(pts[1]); } 
            if (!isNaN(s)) { var ans = right.split(/\s+/).filter(x => x); if (s === e && ans.length === 1) ansMap[s] = ans[0]; else for (var j = 0; j <= e - s; j++) if (ans[j]) ansMap[s + j] = ans[j]; } 
        }); 
        var list = [], curQ = null, type = "å•é€‰é¢˜"; 
        qT.split('\n').forEach(l => { 
            l = l.trim(); if (!l) return; 
            if (l.indexOf('åˆ¤æ–­é¢˜') > -1) type = 'åˆ¤æ–­é¢˜'; else if (l.indexOf('å•é€‰é¢˜') > -1) type = 'å•é€‰é¢˜'; else if (l.indexOf('å¤šé€‰é¢˜') > -1) type = 'å¤šé€‰é¢˜'; 
            var dotIdx = l.indexOf('.'); var potentialNum = parseInt(l.substring(0, dotIdx)); 
            if (dotIdx > 0 && dotIdx < 5 && !isNaN(potentialNum)) { 
                if (curQ) list.push(curQ); 
                var id = potentialNum; 
                if (id <= 20) type = 'åˆ¤æ–­é¢˜'; else if (id <= 80) type = 'å•é€‰é¢˜'; else type = 'å¤šé€‰é¢˜'; 
                curQ = { id: id, type: type, text: l.substring(dotIdx + 1).trim(), options: [], answer: ansMap[id] || '?' }; 
            } else if (l.indexOf('A.') === 0 || l.indexOf('B.') === 0 || l.indexOf('C.') === 0 || l.indexOf('D.') === 0 || l.indexOf('E.') === 0 || l.indexOf('F.') === 0) { 
                if (curQ) curQ.options.push(l); 
            } else if (curQ && l.indexOf('ã€') === -1) { curQ.text += l; } 
        }); 
        if (curQ) list.push(curQ); 
        database[set] = list; saveData(); alert("å¯¼å…¥æˆåŠŸï¼"); closeImportModal(); 
    }
    
    function exportToFile() { 
        var a = document.createElement('a'); 
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(database)); 
        a.download = "é¢˜åº“å¤‡ä»½.json"; 
        document.body.appendChild(a); a.click(); a.remove(); 
    }
    
    function importFromFile(input) { 
        var file = input.files[0]; if (!file) return; 
        var reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                var data = JSON.parse(e.target.result); 
                for(let key in data) { 
                    if (key === 'mistakes') { 
                        if (!database.mistakes) database.mistakes = []; 
                        data.mistakes.forEach(m => { if (!database.mistakes.some(em => em.text === m.text)) database.mistakes.push(m); }); 
                    } else if (key === 'examHistory') { 
                        if(!database.examHistory) database.examHistory = []; 
                        database.examHistory = data.examHistory.concat(database.examHistory); 
                    } else { 
                        database[key] = data[key]; 
                    } 
                } 
                saveData(); alert("æ¢å¤æˆåŠŸ"); input.value = ''; 
            } catch(e) { alert("æ–‡ä»¶é”™è¯¯"); } 
        }; 
        reader.readAsText(file); 
    }
</script>
</body>

</html>

